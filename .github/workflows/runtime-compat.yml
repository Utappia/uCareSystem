name: Runtime Compatibility

permissions:
  contents: read

on:
  push:
    branches: [ develop, main ]
    paths:
      - 'src/**'
      - 'scripts/runtime-tests/**'
      - '.github/workflows/runtime-compat.yml'
  pull_request:
    branches: [ develop, main ]
    paths:
      - 'src/**'
      - 'scripts/runtime-tests/**'
      - '.github/workflows/runtime-compat.yml'
  workflow_dispatch:
    inputs:
      docker_images:
        description: 'Docker image list (space-separated)'
        required: false
        default: 'ubuntu:22.04 ubuntu:24.04 ubuntu:25.10'
      scenarios:
        description: 'Scenario list (space-separated)'
        required: false
        default: 'smoke maintenance'
      lxd_image:
        description: 'LXD fallback image'
        required: false
        default: 'images:ubuntu/24.04'
      enable_vm_fallback:
        description: 'Require manual VM fallback step'
        required: false
        type: boolean
        default: false

jobs:
  runtime-docker:
    name: Runtime on Docker
    runs-on: ubuntu-latest
    outputs:
      docker_failed: ${{ steps.status.outputs.docker_failed }}
      escalate: ${{ steps.status.outputs.escalate }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run runtime matrix on Docker
        id: docker
        continue-on-error: true
        env:
          UCARE_DOCKER_IMAGES: ${{ github.event.inputs.docker_images || 'ubuntu:22.04 ubuntu:24.04 ubuntu:25.10' }}
          UCARE_SCENARIOS: ${{ github.event.inputs.scenarios || 'smoke maintenance' }}
        run: |
          bash scripts/runtime-tests/run_docker_matrix.sh

      - name: Decide escalation
        id: status
        if: always()
        run: |
          if [ "${{ steps.docker.outcome }}" = "success" ]; then
            echo "docker_failed=false" >> "$GITHUB_OUTPUT"
            echo "escalate=false" >> "$GITHUB_OUTPUT"
          else
            echo "docker_failed=true" >> "$GITHUB_OUTPUT"
            echo "escalate=true" >> "$GITHUB_OUTPUT"
          fi

  runtime-lxd:
    name: Runtime on LXD fallback
    runs-on: ubuntu-latest
    needs: runtime-docker
    if: needs.runtime-docker.outputs.escalate == 'true'
    outputs:
      lxd_failed: ${{ steps.status.outputs.lxd_failed }}
      vm_required: ${{ steps.status.outputs.vm_required }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install and initialize LXD
        id: lxd_setup
        continue-on-error: true
        run: |
          sudo snap install lxd
          sudo lxd init --auto

      - name: Run runtime fallback on LXD
        id: lxd_run
        continue-on-error: true
        env:
          UCARE_LXD_IMAGE: ${{ github.event.inputs.lxd_image || 'images:ubuntu/24.04' }}
          UCARE_SCENARIOS: ${{ github.event.inputs.scenarios || 'smoke maintenance' }}
        run: |
          bash scripts/runtime-tests/run_lxd_fallback.sh

      - name: Decide VM requirement
        id: status
        if: always()
        run: |
          if [ "${{ steps.lxd_setup.outcome }}" != "success" ]; then
            echo "lxd_failed=true" >> "$GITHUB_OUTPUT"
            echo "vm_required=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${{ steps.lxd_run.outcome }}" = "success" ]; then
            echo "lxd_failed=false" >> "$GITHUB_OUTPUT"
            echo "vm_required=false" >> "$GITHUB_OUTPUT"
          else
            echo "lxd_failed=true" >> "$GITHUB_OUTPUT"
            echo "vm_required=true" >> "$GITHUB_OUTPUT"
          fi

  runtime-vm-notice:
    name: VM fallback notice
    runs-on: ubuntu-latest
    needs: [runtime-docker, runtime-lxd]
    if: always() && needs.runtime-docker.outputs.docker_failed == 'true' && (needs.runtime-lxd.outputs.vm_required == 'true')
    steps:
      - name: VM fallback policy
        run: |
          echo "Docker and LXD could not validate runtime scenarios."
          echo "Use a self-hosted VM runner for final fallback validation."
          if [ "${{ github.event.inputs.enable_vm_fallback || 'false' }}" = "true" ]; then
            echo "VM fallback was requested. Please trigger your self-hosted VM pipeline."
            exit 1
          fi

  runtime-gate:
    name: Runtime Gate
    runs-on: ubuntu-latest
    needs: [runtime-docker, runtime-lxd, runtime-vm-notice]
    if: always()
    steps:
      - name: Evaluate gate
        run: |
          docker_failed="${{ needs.runtime-docker.outputs.docker_failed }}"
          lxd_failed="${{ needs.runtime-lxd.outputs.lxd_failed }}"
          vm_required="${{ needs.runtime-lxd.outputs.vm_required }}"

          if [ "$docker_failed" = "false" ]; then
            echo "Runtime validation passed on Docker."
            exit 0
          fi

          if [ "$docker_failed" = "true" ] && [ "$lxd_failed" = "false" ]; then
            echo "Runtime validation passed on LXD fallback."
            exit 0
          fi

          if [ "$vm_required" = "true" ]; then
            echo "Runtime validation needs VM fallback per policy."
            exit 1
          fi

          echo "Runtime validation failed."
          exit 1
